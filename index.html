<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Weather Map</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
body {
  margin:0;
  height:100vh;
  background:#111;
  color:#fff;
  font-family:system-ui, sans-serif;
  overflow:hidden;
}

/* Map */
#map { width:100%; height:100vh; }

/* Info panel */
.info-panel {
  position:absolute;
  top:20px;
  right:20px;
  width:340px;
  z-index:1000;
  display:flex;
  flex-direction:column;
  gap:1rem;
}

/* Card common */
.card-weather {
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(10px);
  border-radius:14px;
  padding:1rem;
  box-shadow:0 6px 16px rgba(0,0,0,0.4);
}

/* Card 1: City & coords */
.card-city {
  text-align:right;
  font-size:0.85rem;
  opacity:0.85;
}
.card-city #time {
  margin-top:0.5rem;
  font-size:0.85rem;
  color:#ccc;
}

/* Card 2: Temperature */
.card-temp {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:0.1rem;
  text-align:center;
  padding:1rem 1rem;
}
.card-temp img {
  width:70px;
  height:70px;
  margin-bottom:0.1rem;
}
.card-temp #temp {
  font-size:2.3rem;
  font-weight:bold;
  margin:0;
}
.card-temp small {
  color:#ccc;
  font-size:0.95rem;
  margin-bottom:0.5rem;
}

/* Card 3: Detailed metrics */
.card-details {
  padding:1rem;
}
.metric {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0.5rem 0;
  font-size:0.85rem;
  border-top:1px solid rgba(255,255,255,0.1);
}
.metric:first-child { border-top:none; }
.metric i { margin-right:6px; opacity:0.7; }

/* Responsive */
@media (max-width:767px){
  body{overflow:auto;}
  #map{height:70vh;}
  .info-panel{
    position:relative;
    width:95%;
    margin:0 auto;
    top:auto;
    right:auto;
  }
  .card-temp img { width:60px; height:60px; }
  .card-temp #temp { font-size:2rem; }
}
</style>
</head>

<body>
<div id="map"></div>

<div class="info-panel">
  <!-- Card 1: City & Coordinates + Local Time -->
  <div class="card-weather card-city">
    <span id="city">—</span>, <span id="country">—</span><br>
    Lat: <strong id="lat">—</strong> Lon: <strong id="lon">—</strong>
    <div id="time">--:--</div>
  </div>

  <!-- Card 2: Temperature -->
  <div class="card-weather card-temp">
    <img id="weather-icon" src="" alt="">
    <span id="temp">--°C</span>
    <small id="feels">Feels like --°C</small>
  </div>

  <!-- Card 3: Detailed Metrics -->
  <div class="card-weather card-details">
    <div class="metric"><span><i class="bi bi-wind"></i>Wind</span><span id="wind">—</span></div>
    <div class="metric"><span><i class="bi bi-droplet"></i>Humidity</span><span id="humidity">—</span></div>
    <div class="metric"><span><i class="bi bi-clouds"></i>Clouds</span><span id="clouds">—</span></div>
    <div class="metric"><span><i class="bi bi-bar-chart-line"></i>Pressure</span><span id="pressure">—</span></div>
    <div class="metric"><span><i class="bi bi-eye"></i>Visibility</span><span id="visibility">—</span></div>
    <div class="metric"><span><i class="bi bi-sunrise"></i>Sunrise</span><span id="sunrise">—</span></div>
    <div class="metric"><span><i class="bi bi-sunset"></i>Sunset</span><span id="sunset">—</span></div>
    <div class="metric"><span><i class="bi bi-moon"></i>Moon</span><span id="moon">—</span></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_KEY = "e1ff48b65c50970d0dadbba9dbc60e10";

const map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
const marker = L.marker([20.5937,78.9629],{draggable:true}).addTo(map);

marker.on('dragend', e => { 
  const {lat, lng} = e.target.getLatLng(); 
  updateLatLon(lat,lng); 
  getWeather(lat,lng); 
});

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords; 
    map.setView([latitude, longitude],10); 
    marker.setLatLng([latitude, longitude]); 
    updateLatLon(latitude, longitude); 
    getWeather(latitude, longitude);
  });
} else getWeather(20.5937,78.9629);

function updateLatLon(lat, lon){ 
  document.getElementById('lat').textContent = lat.toFixed(3); 
  document.getElementById('lon').textContent = lon.toFixed(3); 
}

function calculateMoonPhase(date){
  const lp = 2551443;
  const new_moon = new Date(1970,0,7,20,35,0).getTime()/1000;
  const phase = ((date.getTime()/1000 - new_moon) % lp)/lp;
  if(phase<0.03||phase>0.97) return "New Moon";
  else if(phase<0.22) return "Waxing Crescent";
  else if(phase<0.28) return "First Quarter";
  else if(phase<0.47) return "Waxing Gibbous";
  else if(phase<0.53) return "Full Moon";
  else if(phase<0.72) return "Waning Gibbous";
  else if(phase<0.78) return "Last Quarter";
  else return "Waning Crescent";
}

async function getWeather(lat, lon){
  try{
    // Current weather
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);
    const d = await res.json();

    // Card 1
    document.getElementById('city').textContent = d.name;
    document.getElementById('country').textContent = d.sys.country;

    // Card 2
    document.getElementById('temp').textContent = Math.round(d.main.temp)+"°C";
    document.getElementById('feels').textContent = "Feels like "+Math.round(d.main.feels_like)+"°C";
    const icon = d.weather[0].icon;
    document.getElementById('weather-icon').src=`https://openweathermap.org/img/wn/${icon}@2x.png`;

    // Card 3
    document.getElementById('wind').textContent = d.wind.speed+" m/s";
    document.getElementById('humidity').textContent = d.main.humidity+"%";
    document.getElementById('clouds').textContent = d.clouds.all+"%";
    document.getElementById('pressure').textContent = d.main.pressure+" hPa";
    document.getElementById('visibility').textContent = (d.visibility/1000).toFixed(1)+" km";
    document.getElementById('sunrise').textContent = new Date(d.sys.sunrise*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('sunset').textContent = new Date(d.sys.sunset*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('moon').textContent = calculateMoonPhase(new Date());

    // Update local time using timezone offset from current weather
    updateLocalTimeWithOffset(d.timezone);

  }catch(e){ console.error(e); }
}

// Local time using timezone offset in seconds
function updateLocalTimeWithOffset(timezoneOffsetSec){
    const nowUtc = new Date().getTime();
    const localMs = nowUtc + timezoneOffsetSec * 1000;
    const localDate = new Date(localMs);

    const hours = localDate.getUTCHours().toString().padStart(2,'0');
    const minutes = localDate.getUTCMinutes().toString().padStart(2,'0');

    const offsetHours = timezoneOffsetSec / 3600;
    const offsetSign = offsetHours >= 0 ? '+' : '-';
    const offsetStr = `GMT${offsetSign}${Math.abs(offsetHours)}`;

    document.getElementById('time').textContent = `${hours}:${minutes} (${offsetStr})`;
}
</script>
</body>
</html>
